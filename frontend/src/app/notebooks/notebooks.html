<div class="flex h-[calc(100vh-64px)] overflow-hidden">
  <!-- Notebooks Sidebar -->
  <aside
    class="notebooks-sidebar w-72 flex-shrink-0 bg-gray-50 dark:bg-dark-panel-left transition-all duration-300 ease-in-out border-r border-gray-200 dark:border-dark-border flex"
  >
    <div class="flex flex-col w-full">
      <!-- Header -->
      <div class="sidebar-header flex items-center justify-between p-4 border-b border-gray-200 dark:border-dark-border transition-colors duration-300">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Cadernos</h2>
        <button (click)="openCreateModal()" class="p-1 text-gray-500 rounded-full hover:bg-gray-200 hover:text-gray-800 dark:text-gray-400 dark:hover:bg-dark-accent dark:hover:text-white transition-colors duration-300" title="Criar novo caderno">
          <lucide-icon name="plus-circle" size="18"></lucide-icon>
        </button>
      </div>

      <!-- Search Box -->
      <div class="p-2">
        <div class="relative">
          <lucide-icon name="search" size="16" class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 dark:text-dark-text-secondary"></lucide-icon>
          <input #searchInput
                type="text"
                placeholder="Buscar caderno..."
                class="w-full pl-9 pr-8 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-dark-primary dark:border-dark-border dark:text-white dark:focus:ring-indigo-600 transition-colors duration-300"
                [value]="searchTerm()"
                (input)="onSearch($event)"
                (keydown.escape)="clearSearch(searchInput)">
          @if (searchTerm()) {
            <button class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-800 dark:text-dark-text-secondary dark:hover:text-white" (click)="clearSearch(searchInput)" title="Limpar busca">
              <lucide-icon name="x" size="16"></lucide-icon>
            </button>
          }
        </div>
      </div>

      <!-- Sort Dropdown -->
      <div class="px-2 pb-2">
        <select 
          class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-dark-primary dark:border-dark-border dark:text-white dark:focus:ring-indigo-600 transition-colors duration-300"
          (change)="changeSortOrder($event)"
          [value]="sortOption().by + '-' + sortOption().direction">
          <option value="createdAt-desc">Mais Recentes</option>
          <option value="createdAt-asc">Mais Antigos</option>
          <option value="name-asc">Nome (A-Z)</option>
          <option value="name-desc">Nome (Z-A)</option>
        </select>
      </div>

      <!-- Notebooks List / Loading / Error State -->
      <div class="overflow-y-auto flex-grow">
        @if (notebookService.isLoading()) {
          <div class="px-2 py-4 space-y-2">
            @for (_ of [1, 2, 3, 4, 5]; track $index) {
              <div class="h-10 bg-gray-200 rounded-md dark:bg-dark-accent animate-pulse"></div>
            }
          </div>
        } @else if (notebookService.loadingError()) {
          <div class="p-4 text-center text-gray-500 dark:text-dark-text-secondary">
            <p class="mb-2">Falha ao carregar cadernos.</p>
            <button (click)="retryFetchNotebooks()" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Tentar Novamente</button>
          </div>
        } @else {
          <div class="notebook-list p-2 space-y-1">
            <!-- Seção de Favoritos -->
            @if (favoriteNotebooks().length > 0) {
              <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1 dark:text-dark-text-secondary">Favoritos</h3>
              <ul class="space-y-1 mb-3">
                @for (notebook of favoriteNotebooks(); track notebook.id) {
                  <li
                    class="flex items-center justify-between px-4 py-2 rounded-md cursor-pointer transition-colors duration-150 group"
                    [class.bg-indigo-100]="notebook.id === selectedNotebookId()"
                    [class.dark:bg-dark-accent]="notebook.id === selectedNotebookId()"
                    [class.hover:bg-gray-200]="notebook.id !== selectedNotebookId()"
                    [class.dark:hover:bg-dark-primary]="notebook.id !== selectedNotebookId()"
                    (click)="selectNotebook(notebook.id)">
                    <div class="flex items-center gap-3 min-w-0">
                      <span class="flex-shrink-0 w-3 h-3 rounded-full" [style.background-color]="notebook.color || '#FFFFFF'"></span>
                      <span class="text-sm truncate font-medium" [class.font-semibold]="notebook.id === selectedNotebookId()" [innerHTML]="notebook.name | highlight: searchTerm()"></span>
                    </div>
                    <div class="notebook-actions flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-150 transition-colors duration-300">
                      <button class="p-1 text-yellow-500 rounded-full hover:bg-yellow-100 dark:hover:bg-yellow-900/50" (click)="toggleFavorite(notebook); $event.stopPropagation()" title="Remover dos favoritos">
                        <lucide-icon name="star" size="14" class="fill-current"></lucide-icon>
                      </button>
                      <button class="p-1 text-gray-500 rounded-full hover:bg-gray-300 dark:text-dark-text-secondary dark:hover:bg-dark-border" (click)="openRenameModal(notebook.id, notebook.name, notebook.color); $event.stopPropagation()" title="Renomear caderno">
                        <lucide-icon name="pencil" size="14"></lucide-icon>
                      </button>
                      <button class="p-1 text-red-500 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50" (click)="openDeleteModal(notebook.id, notebook.name); $event.stopPropagation()" title="Deletar caderno">
                        <lucide-icon name="trash-2" size="14"></lucide-icon>
                      </button>
                    </div>
                  </li>
                }
              </ul>
            }

            <!-- Seção de Cadernos -->
            @if (favoriteNotebooks().length > 0 && regularNotebooks().length > 0) {
              <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1 dark:text-dark-text-secondary">Cadernos</h3>
            }
            <ul class="space-y-1">
              @for (notebook of regularNotebooks(); track notebook.id) {
                <li
                  class="flex items-center justify-between px-4 py-2 rounded-md cursor-pointer transition-colors duration-150 group"
                  [class.bg-indigo-100]="notebook.id === selectedNotebookId()"
                  [class.dark:bg-dark-accent]="notebook.id === selectedNotebookId()"
                  [class.hover:bg-gray-200]="notebook.id !== selectedNotebookId()"
                  [class.dark:hover:bg-dark-primary]="notebook.id !== selectedNotebookId()"
                  (click)="selectNotebook(notebook.id)">
                  <div class="flex items-center gap-3 min-w-0">
                    <span class="flex-shrink-0 w-3 h-3 rounded-full" [style.background-color]="notebook.color || '#FFFFFF'"></span>
                    <span class="text-sm truncate font-medium" [class.font-semibold]="notebook.id === selectedNotebookId()" [innerHTML]="notebook.name | highlight: searchTerm()"></span>
                  </div>
                  <div class="notebook-actions flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-150 transition-colors duration-300">
                    <button class="p-1 text-gray-400 rounded-full hover:bg-gray-300 dark:hover:bg-dark-border" (click)="toggleFavorite(notebook); $event.stopPropagation()" title="Adicionar aos favoritos">
                      <lucide-icon name="star" size="14"></lucide-icon>
                    </button>
                    <button class="p-1 text-gray-500 rounded-full hover:bg-gray-300 dark:text-dark-text-secondary dark:hover:bg-dark-border" (click)="openRenameModal(notebook.id, notebook.name, notebook.color); $event.stopPropagation()" title="Renomear caderno">
                      <lucide-icon name="pencil" size="14"></lucide-icon>
                    </button>
                    <button class="p-1 text-red-500 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50" (click)="openDeleteModal(notebook.id, notebook.name); $event.stopPropagation()" title="Deletar caderno">
                      <lucide-icon name="trash-2" size="14"></lucide-icon>
                    </button>
                  </div>
                </li>
              }
            </ul>
          </div>
        }
      </div>
    </div>
  </aside>

  <!-- Notes Column -->
  <main
    class="notes-column w-80 flex-shrink-0 bg-gray-100 dark:bg-dark-panel-middle border-l border-gray-200 dark:border-dark-border transition-all duration-300 ease-in-out flex"
  >
    @if (selectedNotebookId()) {
      <app-note-column
        [notebookId]="selectedNotebookId()"
        (noteSelected)="onNoteSelected($event)"
      ></app-note-column>
    } @else {
      <div class="placeholder flex items-center justify-center h-full text-gray-500 dark:text-dark-text-secondary">
        Selecione um caderno para ver as notas.
      </div>
    }
  </main>

  <!-- Note Editor -->
  <section
    class="note-editor-column flex-grow relative bg-white dark:bg-dark-panel-right border-l border-gray-200 dark:border-dark-border transition-all duration-300 ease-in-out flex"
  >
    <div class="absolute inset-0" [@routeAnimation]="outlet.isActivated ? outlet.activatedRoute : ''">
      <router-outlet #outlet="outlet"></router-outlet>
    </div>
  </section>
</div>

<!-- Modals -->
@if (showDeleteModal()) {
  <app-modal
    title="Confirmar Deleção"
    [message]="'Tem certeza que deseja deletar o caderno &quot;' + notebookToDelete()?.name + '&quot;? Todas as notas contidas nele serão perdidas. Esta ação não pode ser desfeita.'"
    confirmText="Deletar"
    (onConfirm)="confirmDeleteNotebook()"
    (onCancel)="closeDeleteModal()"
  ></app-modal>
}

@if (showCreateRenameModal()) {
  <app-modal
    [title]="modalMode() === 'create' ? 'Criar Novo Caderno' : 'Renomear Caderno'"
    confirmText="Salvar"
    (onConfirm)="handleSaveNotebook()"
    (onCancel)="closeCreateRenameModal()" 
  >
    <div class="space-y-4">
      <input #notebookNameInput type="text" [(ngModel)]="newNotebookName" class="w-full p-2 border border-gray-300 rounded-lg dark:bg-dark-primary dark:border-dark-border dark:text-white" placeholder="Nome do caderno" (keydown.enter)="handleSaveNotebook()">
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium text-gray-700 dark:text-dark-text-secondary">Cor:</label>
        <div class="flex gap-2">
          @for (color of availableColors; track color) {
            <button
              class="w-6 h-6 rounded-full border-2 transition-transform duration-150"
              [style.background-color]="color"
              [class.border-indigo-500]="newNotebookColor() === color"
              [class.border-transparent]="newNotebookColor() !== color"
              [class.scale-110]="newNotebookColor() === color"
              (click)="newNotebookColor.set(color)"
            ></button>
          }
        </div>
      </div>
    </div>
  </app-modal>
}
