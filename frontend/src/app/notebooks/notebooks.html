<div class="three-column-layout">
  <aside class="notebooks-sidebar">
    <div class="sidebar-header">
      <h2>Cadernos</h2>
      <button (click)="openCreateModal()" class="add-notebook-btn" title="Criar novo caderno">
        <lucide-icon name="plus-circle" size="16"></lucide-icon>
      </button>
    </div>
    <div class="search-box">
      <input #searchInput
             type="text"
             placeholder="Buscar caderno..."
             [value]="searchTerm()"
             (input)="onSearch($event)"
             (keydown.escape)="clearSearch(searchInput)">
      @if (searchTerm()) {
        <button class="clear-search-btn" (click)="clearSearch(searchInput)" title="Limpar busca">&times;</button>
      }
    </div>
    @if (notebookService.isLoading()) {
      <div class="skeleton-container">
        @for (_ of [1, 2, 3, 4, 5]; track $index) {
          <div class="skeleton-item"></div>
        }
      </div>
    } @else if (notebookService.loadingError()) {
      <div class="error-indicator">
        <p>Falha ao carregar.</p>
        <button (click)="retryFetchNotebooks()">Tentar Novamente</button>
      </div>
    } @else {
      <ul class="notebook-list">
        @for (notebook of filteredNotebooks(); track notebook.id) {
        <li class="notebook-item" [class.selected]="notebook.id === selectedNotebookId()" (click)="selectNotebook(notebook.id)">
          <span [innerHTML]="notebook.name | highlight: searchTerm()"></span>
          <div class="notebook-actions">
            <button class="rename-notebook-btn" (click)="openRenameModal(notebook.id, notebook.name); $event.stopPropagation()" title="Renomear caderno">
              <lucide-icon name="pencil" size="16"></lucide-icon>
            </button>
            <button class="delete-notebook-btn" (click)="openDeleteModal(notebook.id, notebook.name); $event.stopPropagation()" title="Deletar caderno">
              <lucide-icon name="trash-2" size="16"></lucide-icon>
            </button>
          </div>
        </li>
        }
      </ul>
    }
  </aside>

  <main class="notes-column">
    @if (selectedNotebookId()) {
      <app-note-column [notebookId]="selectedNotebookId()" (noteSelected)="onNoteSelected($event)"></app-note-column>
    } @else {
      <div class="placeholder">Selecione um caderno para ver as notas.</div>
    }
  </main>

  <section class="note-editor-column">
    <!-- O router-outlet gerencia se o NoteEditor deve ser exibido ou não -->
    <router-outlet></router-outlet>
  </section>
</div>
<!-- Modal de Confirmação de Deleção -->
@if (showDeleteModal()) {
<app-modal
  title="Confirmar Deleção"
  [message]="'Tem certeza que deseja deletar o caderno &quot;' + notebookToDelete()?.name + '&quot;? Esta ação não pode ser desfeita.'"
  confirmText="Deletar"
  (onConfirm)="confirmDeleteNotebook()"
  (onCancel)="closeDeleteModal()"
></app-modal>
}

<!-- Modal de Criar/Renomear Caderno -->
@if (showCreateRenameModal()) {
<app-modal
  [title]="modalMode() === 'create' ? 'Criar Novo Caderno' : 'Renomear Caderno'"
  confirmText="Salvar"
  (onConfirm)="handleSaveNotebook()"
  (onCancel)="closeCreateRenameModal()"
>
  <input type="text" [(ngModel)]="newNotebookName" class="w-full p-2 border rounded-lg" placeholder="Nome do caderno" (keydown.enter)="handleSaveNotebook()">
</app-modal>
}