<div class="p-4">
  <!-- Barra de Ferramentas: Busca e Botão de Criar -->
  <div class="mb-4 flex flex-wrap items-center justify-between gap-4"> 
    <div class="relative flex-grow">
      <input
        type="text"
        aria-label="Buscar notas por título ou conteúdo" placeholder="Buscar notas por título ou conteúdo..."
        [value]="searchTerm()"
        (input)="onSearch($event)"
        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-dark-primary dark:border-dark-border dark:text-white transition-colors duration-300"
      />
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <lucide-icon name="search" size="18" class="text-gray-400 dark:text-dark-text-secondary"></lucide-icon>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button (click)="openCreateNoteModal()" aria-label="Criar nova nota" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">
        <lucide-icon name="plus" size="16"></lucide-icon>
        <span>Criar Nota</span>
      </button>
    </div>
  </div>

  @if (isLoading()) {
    <p class="text-center text-gray-500 dark:text-dark-text-secondary">Carregando notas...</p>
  } @else if (error()) {
    <p class="text-red-500" role="alert">{{ error() }}</p>
  } @else if (filteredNotes().length === 0) {    
    <div class="text-center py-10 px-4 bg-gray-50 dark:bg-dark-accent/20 rounded-lg transition-colors duration-300" role="status">
      <lucide-icon name="file-text" size="48" class="mx-auto text-gray-400 dark:text-dark-text-secondary"></lucide-icon>
      <h3 class="mt-2 text-lg font-medium text-gray-800 dark:text-white">{{ searchTerm() ? 'Nenhuma nota encontrada para "' + searchTerm() + '"' : 'Nenhuma nota encontrada' }}</h3>
      <p class="mt-1 text-sm text-gray-500 dark:text-dark-text-secondary">{{ !searchTerm() ? 'Crie sua primeira nota neste caderno!' : 'Tente uma busca diferente.' }}</p>
    </div>
  } @else if (filteredNotes().length > 0) {
    <div class="space-y-2" @listAnimation role="region" aria-live="polite"> 
      @for (note of filteredNotes(); track note.id) {
        <div role="article" tabindex="0" class="bg-white dark:bg-dark-primary rounded-lg shadow-md p-3 flex items-center justify-between group cursor-pointer" (click)="openNoteEditor(note)">
          <!-- Main content area -->
          <div class="flex items-center flex-grow overflow-hidden min-w-0">
            <!-- Pin Button (Visible) -->
            <button (click)="togglePin(note); $event.stopPropagation()"
                    [attr.aria-label]="note.isPinned ? 'Desafixar nota' : 'Fixar nota'"
                    class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors mr-2 flex-shrink-0">
              <lucide-icon name="pin" size="18"
                           [ngClass]="note.isPinned ? 'text-indigo-500 fill-current' : 'text-gray-400 dark:text-gray-500'"></lucide-icon>
            </button>
        
            <!-- Note Title, Content, and Tags -->
            <div class="flex-grow overflow-hidden min-w-0">
              <h3 class="font-bold text-md truncate" [innerHTML]="note.title | highlight: searchTerm()"></h3>
              <div class="text-gray-500 dark:text-dark-text-secondary text-sm line-clamp-1" [innerHTML]="note.content | highlight: searchTerm()"></div>
               <div class="mt-2 flex flex-wrap gap-1">
                @for (tag of note.tags; track tag) {
                  <span class="bg-gray-200 dark:bg-dark-accent text-gray-700 dark:text-dark-text-secondary text-xs font-medium px-2 py-0.5 rounded-full">{{ tag }}</span>
                }
              </div>
            </div>
          </div>
        
          <!-- More Options Menu (to the right) -->
          <div class="relative ml-2">
            <button (click)="toggleNoteMenu(note.id, $event)" class="menu-button p-1 rounded-full text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
              <lucide-icon name="more-vertical" size="18"></lucide-icon>
            </button>
            @if (isNoteMenuOpen() === note.id) {
              <div class="absolute right-0 mt-2 w-56 bg-white dark:bg-dark-secondary rounded-md shadow-lg z-10" (click)="$event.stopPropagation()">
                <button (click)="openMoveNoteModal(note)" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-dark-text hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                  <lucide-icon name="move" size="16"></lucide-icon>
                  <span>Mover para Caderno...</span>
                </button>
                <div class="border-t border-gray-200 dark:border-dark-border my-1"></div>
                <button (click)="deleteNote(note.id, note.title); closeNoteMenu()" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                  <lucide-icon name="trash-2" size="16"></lucide-icon>
                  <span>Deletar Nota</span>
                </button>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>


<!-- Modal de Confirmação de Exclusão -->
<app-confirmation-modal role="dialog" aria-modal="true" aria-labelledby="delete-confirmation-modal-title"
  [isVisible]="showDeleteConfirmationModal()" 
  [message]="'Tem certeza que deseja deletar a nota &quot;' + noteToDelete()?.title + '&quot;? Esta ação não pode ser desfeita.'"
  (confirm)="confirmDeleteNote()"
  (cancel)="cancelDeleteNote()"
></app-confirmation-modal>

<!-- Modal para Mover Nota -->
<app-move-note-modal
  [isVisible]="showMoveNoteModal()"
  [notebooks]="notebooks()"
  [currentNotebookId]="notebookId"
  (confirm)="confirmMoveNote($event)"
  (cancel)="closeMoveNoteModal()"
></app-move-note-modal>